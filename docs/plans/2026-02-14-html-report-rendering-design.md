# HTML Report Rendering Design

**Date**: 2026-02-14
**Status**: Approved
**Scope**: cortex-notes-web (frontend) + cortex-notes-db (indexing pipeline + CI)

## Problem

cortex-notes-db contains 4 HTML reports in `reports/` generated by Antigravity Deep Researcher. These reports have rich visual styling (dark themes, gradients, card layouts, comparison tables). The current system cannot display them because:

1. `update_index.py` only scans `*.md` files
2. GitHub Actions only trigger on `**/*.md` paths
3. The frontend assumes all content is Markdown (uses `gray-matter` + line-by-line text rendering)

## Solution

Render HTML reports in a sandboxed iframe on the frontend. Extend the indexing pipeline to scan HTML files using Python stdlib.

## Architecture

```
cortex-notes-db                          cortex-notes-web
┌─────────────────────┐                  ┌──────────────────────┐
│ reports/*.html       │──GitHub API──→  │ NoteViewer           │
│ content/**/*.md      │                 │  ├─ html → iframe    │
│ index.json (md+html) │                 │  └─ else → markdown  │
│ scripts/             │                 └──────────────────────┘
│  └─ update_index.py  │
└─────────────────────┘
```

## Changes

### 1. Frontend — `src/lib/github.js`

`getNote()` checks the `format` field from index.json. If `html`, returns raw content without gray-matter parsing. Metadata (title, tags, dates) comes from index.json, not the HTML file.

### 2. Frontend — New `src/components/HtmlRenderer.jsx`

Sandboxed iframe renderer:

- `sandbox=""` (strictest — no scripts, no same-origin, no forms, no popups)
- Injected CSP meta tag: `default-src 'none'; style-src 'unsafe-inline'; img-src data:;`
- Fixed height `calc(100vh - 120px)` with internal scrolling
- `title` attribute set to `note.title` for accessibility
- Path validation: refuse to render if `format: 'html'` but path is outside `reports/`

### 3. Frontend — `NoteViewer` in `src/App.jsx`

- If `note.format === 'html'`, render with `HtmlRenderer`
- Hide Edit button for HTML notes (read-only)
- Delete button remains available
- Metadata header (title, tags, date) displayed above iframe from index.json

### 4. DB — `scripts/update_index.py`

- Use Python stdlib `html.parser` (no external dependencies)
- Scan `reports/*.html` in addition to `**/*.md`
- HTML scanning constrained to `reports/` directory only
- Extract `<title>` for title, body text for excerpt (excluding `<style>` and `<script>` content)
- HTML index entries include `"format": "html"` field

### 5. CI — `.github/workflows/update-index.yml`

- Consolidate `update-index.yml` and `rebuild-index.yml` into single workflow
- Delete `rebuild-index.yml` (eliminates race condition)
- Trigger on `**/*.md` + `reports/**/*.html`
- Add `concurrency: { group: index-update, cancel-in-progress: true }`
- Auto-commit message includes `[skip ci]` to prevent infinite loop

### 6. CI — `validate.yml`

No change. HTML files have no frontmatter to validate.

## Security

- `sandbox=""` prevents all script execution and cross-origin access
- CSP meta tag blocks external resource loading inside iframe
- Content source is private repo only (not user-generated content)
- Frontend path validation rejects `format: html` entries outside `reports/`

## Not In Scope

- HTML editing (reports are read-only)
- Full-text search within HTML content (index excerpt is sufficient)
- iframe height auto-adaptation (requires `allow-same-origin`, rejected for security)
- Dark mode consistency between app shell and HTML reports

## Expert Review

Reviewed by Security, React Architecture, and DevOps/CI experts. All concerns resolved. See conversation history for full review transcript.
